{% block body %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listado de Usuarios</title>
  <style>
    .pagination {
      justify-content: center;
    }
  </style>
</head>

<div class="row">
  <!-- ... tu contenido aquí ... -->
   <!--[ daily sales section ] start-->
   <div class="col-md-6 col-xl-4">
    <div class="card daily-sales">
      <div class="card-block">
        <h6 class="mb-4">Mensajes Enviados</h6>
        <div class="row d-flex align-items-center">
          <div class="col-9">
            <h3 class="f-w-300 d-flex align-items-center m-b-0"><i
                class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>
               
              332</h3>
          </div>

          <div class="col-3 text-right">
            <p class="m-b-0">67%</p>
          </div>
        </div>
        <div class="progress m-t-30" style="height: 7px;">
          <div class="progress-bar progress-c-theme" role="progressbar" style="width: 50%;"
            aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
  <!--[ daily sales section ] end-->
<!--[ Monthly  sales section ] starts-->
<div class="col-md-6 col-xl-4">
    <div class="card Monthly-sales">
      <div class="card-block">
        <h6 class="mb-4">Mensajes Pendientes</h6>
        <div class="row d-flex align-items-center">
          <div class="col-9">
            <h3 class="f-w-300 d-flex align-items-center  m-b-0"><i
                class="feather icon-arrow-down text-c-red f-30 m-r-10"></i>$
              2.942.32</h3>
          </div>
          <div class="col-3 text-right">
            <p class="m-b-0">36%</p>
          </div>
        </div>
        <div class="progress m-t-30" style="height: 7px;">
          <div class="progress-bar progress-c-theme2" role="progressbar" style="width: 35%;"
            aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
  <!--[ Monthly  sales section ] end-->
<!--[ year  sales section ] starts-->
<div class="col-md-12 col-xl-4">
    <div class="card yearly-sales">
      <div class="card-block">
        <h6 class="mb-4">Total de Mensajes</h6>
        <div class="row d-flex align-items-center">
          <div class="col-9">
            <h3 class="f-w-300 d-flex align-items-center  m-b-0"><i
                class="feather icon-arrow-up text-c-green f-30 m-r-10"></i>$
              8.638.32</h3>
          </div>
          <div class="col-3 text-right">
            <p class="m-b-0">80%</p>
          </div>
        </div>
        <div class="progress m-t-30" style="height: 7px;">
          <div class="progress-bar progress-c-theme" role="progressbar" style="width: 70%;"
            aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
  <!--[ year  sales section ] end-->
  
 <!--[ Recent Users ] start-->
 
 <div class="col-xl-8 col-md-6">
    <div class="card Recent-Users">
        
        <div class="card-header">
          <h5>Listados de Usuarios</h5>
        </div>
        
        <div class="card-block px-0 py-3">
          <div class="table-responsive">
          <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
            <table class="table table-hover" table id="dataTable">
                <thead>
                    <tr>
                      <th>Usuario</th>
                      <th>Tiempo</th>
                      <th>Fecha Inicio</th>
                      <th>Estado Mensaje</th>
                      <th>Acciones</th>
                      <th class="text-right"></th>
                    </tr>
                  </thead>
              <tbody id="clientesBody">
                {% for c in usuarios %}

                  <tr class="unread">
                    
                    <td>
                      <h6 class="mb-1">{{ c.nombreC}}</h6>
                      <p class="m-0">0{{ c.telefono}}</p>
                    </td>
                    <td>
                        
                        <h6 class="mb-1">{{ c.tiempoH}} horas</h6>
                    </td>
                    <td>
                        <h6 class="mb-1">{{ c.campo6}}</h6>
                      </td>
                      <td>
                        {% if c.campo3 == 'PENDIENTE' %}
                        <h6 class="m-0 text-c-red">{{ c.campo3}}</h6>
                        {% else %}
                        <h6 class="m-0 text-c-green">{{ c.campo3}}</h6>
                        <p class="m-0">{{ c.campo5}}</p>
                        {% endif %}
                    <td>
                      <button class="btn btn-primary edit-btn" data-telefono="{{ c.telefono }}">Edit</button>
                      <button class="btn btn-primary" data-toggle="modal" data-target="#editModal" data-url="{% url 'edit_cliente' c.pk %}">Editarrrr</button>
                      <a href="{% url 'edicionUsuario' telefono=c.telefono %}" class="label theme-bg2 text-white f-12">Editar</a>
                      <a href="{% url 'eliminarUsuarios' telefono=c.telefono %}" class="label theme-bg text-white f-12">Eliminar</a>
                      <a href="{% url 'enviarNotifi' telefono=c.telefono nombreC=c.nombreC mensaje=c.mensaje%}"class="label text-c-purple f-12">Mensaje</a>
                    </td>
                    
                  </tr>

                {% endfor %}
              </tbody>
              
            </table>
              <!-- Controles de Paginación -->
              <nav aria-label="Page navigation example">
                <ul class="pagination" id="pagination">
                    <!-- Los controles de paginación serán generados por JavaScript -->
                </ul>
            </nav>
          </div>
       
        </div>
    </div>
  </div>
  
  <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
    <div class="card">
        <div class="card-header">
            <a class="btn btn-primary m-t-5" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="true" aria-controls="collapseExample">Nuevo Usuario</a>
            
        </div>
        <div class="collapse show" id="collapseExample" >
            <div class="card-body">
                <form action="/registrarUsuarios/" method="POST">{% csrf_token %}
                    <div class="form-group">
                        <input type="text" id="txtTelefono" name="txtTelefono" class="form-control" placeholder="Telefono"
                          minlength="9" maxlength="9"required value="">
                    </div>
                    <div class="form-group">
                        <input type="text" id="txmensaje" name="txmensaje" class="form-control" placeholder="Mensaje"
                            required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="txNombreC" name="txNombreC" class="form-control" placeholder="Nombre Cliente"
                            required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="txtNombreR" name="txtNombreR" class="form-control" placeholder="Nombre Reprentante"
                            maxlength="50" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="numHoras" name="numHoras" class="form-control" min="1" max="12"
                            value="1" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block text-white">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-dismissible alert-success">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <strong class="text-dark">{{ message }}</strong>
    </div>
    {% endfor %}
    {% endif %}
</div>

  <!-- Modal de Edición -->
  <div class="modal fade" id="editarModal" tabindex="-1" role="dialog" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarModalLabel">Editar Usuario</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="form-editar">
            <div class="form-group">
              <label for="nombreR">Nombre Representante</label>
              <input type="text" class="form-control" id="nombreR" name="nombreR">
            </div>
            <div class="form-group">
              <label for="nombreC">Nombre Cliente</label>
              <input type="text" class="form-control" id="nombreC" name="nombreC">
            </div>
            <div class="form-group">
              <label for="campo3">Estado</label>
              <input type="text" class="form-control" id="campo3" name="campo3">
            </div>
            <div class="form-group">
              <label for="telefono">Telefono</label>
              <input type="text" class="form-control" id="telefono" name="telefono">
            </div>
            <input type="hidden" id="telefono">
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts de Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts Personalizados -->
  <script>
    // Función de búsqueda
    const searchInput = document.getElementById('searchInput');
    const dataTable = document.getElementById('dataTable');
    const dataRows = dataTable.getElementsByTagName('tr');

    searchInput.addEventListener('input', function() {
      const searchText = searchInput.value.toLowerCase();
      for (let i = 0; i < dataRows.length; i++) {
        const rowData = dataRows[i].innerText.toLowerCase();
        dataRows[i].style.display = rowData.includes(searchText) ? '' : 'none';
      }
    });

   // Función de paginación y carga de datos
  document.addEventListener('DOMContentLoaded', function() {
    const rowsPerPage = 5;
    const tableBody = document.querySelector('#clientesBody');
    const pagination = document.querySelector('#pagination');
    const searchInput = document.querySelector('#searchInput');

    function fetchUsers(pageNumber = 1, searchTerm = '') {
      fetch(`/listado_usuarios/?page=${pageNumber}&search=${searchTerm}`)
        .then(response => response.json())
        .then(data => {
          renderTable(data.clientes);
          setupPagination(data.num_pages, data.current_page);
        });
    }

    function renderTable(clientes) {
      tableBody.innerHTML = '';
      clientes.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <h6 class="mb-1">${user.nombreC}</h6>
            <p class="m-0">0${user.telefono}</p>
          </td>
          <td>
            <h6 class="mb-1">${user.tiempoH} horas</h6>
          </td>
          <td>
            <h6 class="mb-1">${user.campo6}</h6>
          </td>
          <td>
            ${user.campo3 === 'PENDIENTE' ? 
              `<h6 class="m-0 text-c-red">${user.campo3}</h6>` : 
              `<h6 class="m-0 text-c-green">${user.campo3}</h6><p class="m-0">${user.campo5}</p>`
            }
          </td>
          <td>
            <a href="#" class="label theme-bg2 text-white f-12 edit-btn" data-telefono="${user.telefono}">Editar</a>
            <a href="/eliminarUsuarios/${user.telefono}" class="label theme-bg text-white f-12">Eliminar</a>
            <a href="/enviarNotifi/${user.telefono}/${user.nombreC}/${user.mensaje}" class="label text-c-purple f-12">Mensaje</a>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function setupPagination(numPages, currentPage) {
      pagination.innerHTML = '';
      for (let i = 1; i <= numPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = 'page-item';
        if (i === currentPage) pageItem.classList.add('active');
        pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageItem.querySelector('a').addEventListener('click', function(event) {
          event.preventDefault();
          fetchUsers(i, searchInput.value);
        });
        pagination.appendChild(pageItem);
      }
    }

    searchInput.addEventListener('input', function() {
      fetchUsers(1, searchInput.value);
    });

    fetchUsers(); // Carga inicial de datos
  });

    // Editar usuario desde el modal
    $(document).ready(function() {
  // Manejo del clic en el botón de editar
  $(document).on('click', '.edit-btn', function() {
    var telefono = $(this).data('telefono');

    // Realizar una solicitud AJAX para obtener los datos del usuario
    $.get(`/obtener_clientess/${telefono}/`, function(data) {
      $('#nombreR').val(data.nombreR);
      $('#nombreC').val(data.nombreC);
      $('#telefono').val(data.telefono);
      $('#campo3').val(data.campo3);
      $('#telefono-id').val(data.telefono); // Asegúrate de tener un campo oculto para el ID del usuario
      $('#editarModal').modal('show'); // Muestra el modal
    });
  });


      $('#form-editar').submit(function(event) {
        event.preventDefault();
        $.ajax({
          url: '/editarUsuario/', // Asegúrate de que esta URL sea correcta
          type: 'POST',
          data: $(this).serialize(),
          success: function(response) {
            $('#editarModal').modal('hide');
            location.reload();
            // Actualiza la vista si es necesario
          }
        });
      });
    });
  </script>
{% endblock %}
